rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(uid) {
      return isSignedIn() && request.auth.uid == uid;
    }

    // -------------------------
    // AccountsPublicInfo/{uid}
    // Public get allowed, list blocked
    // -------------------------
    match /AccountsPublicInfo/{uid} {
      allow get: if true;
      allow list: if false;

      allow create, update, delete: if isOwner(uid);
    }

    // -------------------------
    // Accounts/{uid}/... (default: only owner)
    // -------------------------
    match /Accounts/{uid} {

      // account root doc
      allow get, list: if isOwner(uid);
      allow create, update, delete: if isOwner(uid);

      // Friends: only owner can manage, or reciprocal add when accepting a request
      match /Friends/{friendUid} {
        allow get, list: if isOwner(uid);
        allow create, update: if isOwner(uid) || (isOwner(friendUid) && exists(/databases/$(database)/documents/Accounts/$(friendUid)/FriendRequests/$(uid)));
        allow delete: if isOwner(friendUid) || isOwner(uid);
      }

      // Rides: Owner can manage, Participants can read
      match /Rides/{rideId} {
        
        function isParticipant() {
           return request.auth.uid in resource.data.participants;
        }

        // Read: Owner OR Participant
        allow get: if isOwner(uid) || isParticipant();
        allow list: if isOwner(uid); // Only owner lists their own rides for now. Guests need specific ID.

        // Write: Only Owner can modify the Ride document itself
        allow create, update, delete: if isOwner(uid);

        // Transcripts: 
        match /Transcripts/{transcriptId} {
            // Read: If user can read the parent Ride, they can read transcripts. 
            // Since we can't easily check parent permission without 'get()', 
            // we'll duplicate the participant check logic or rely on the parent doc existence check if possible.
            // Using get() on parent Ride to check participants list.
            
            function isParentTripParticipant() {
                let rideData = get(/databases/$(database)/documents/Accounts/$(uid)/Rides/$(rideId)).data;
                return request.auth.uid in rideData.participants;
            }

            allow read: if isOwner(uid) || isParentTripParticipant();

            // Create: Owner OR Participant
            // Must enforce that authorId matches auth.uid
            allow create: if (isOwner(uid) || isParentTripParticipant()) 
                          && request.resource.data.authorId == request.auth.uid;

            // Delete: Owner of Ride OR Author of Transcript
            allow delete: if isOwner(uid) || (resource.data.authorId == request.auth.uid);
            
            // Update: No updates allowed on transcripts for now (integrity), or only author. 
            // Let's allow author to update.
            allow update: if isOwner(uid) || (resource.data.authorId == request.auth.uid);
        }
      }

      // FriendRequests:
      // - requester can create/delete their own request doc
      // - receiver (owner uid) can read/list and delete (accept/deny)
      match /FriendRequests/{requesterUid} {
        // read:
        // owner sees all requests; requester can read their own request doc
        allow get: if isOwner(uid) || isOwner(requesterUid);
        allow list: if isOwner(uid);

        // create/update:
        // requester writes into target user's FriendRequests/{requesterUid}
        allow create, update: if isOwner(requesterUid);

        // delete:
        // requester can cancel; owner can remove when accepting/denying
        allow delete: if isOwner(uid) || isOwner(requesterUid);

        // update:
        // usually you don't need updates for requests; keep it locked
        allow update: if false;
      }

      // Any other subcollections/docs under Accounts/{uid}/...
      match /{document=**} {
        allow read, write: if isOwner(uid);
      }
    }
  }
}
